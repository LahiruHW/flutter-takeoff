name: Build Release
on:
  push:
    branches:
      - main
    paths:
      - 'pkg/version/version.go'
      - '.github/workflows/build_release.yml'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_changed: ${{ steps.check_version.outputs.changed }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'

      - name: Get current version from code
        id: get_version
        run: |
          VERSION=$(go run -C . << 'EOF'
          package main
          import (
            "fmt"
            "flutter_takeoff/pkg/version"
          )
          func main() {
            fmt.Print(version.Version())
          }
          EOF
          )
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: v$VERSION"

      - name: Get latest release
        id: latest_release
        run: |
          LATEST=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name // "none"')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST"

      - name: Check if version changed
        id: check_version
        run: |
          CURRENT="${{ steps.get_version.outputs.version }}"
          LATEST="${{ steps.latest_release.outputs.latest }}"
          
          if [ "$LATEST" = "none" ] || [ "$CURRENT" != "$LATEST" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Version changed: $LATEST -> $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $CURRENT"
          fi

      - name: Check if tag exists
        id: check_tag
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $VERSION already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $VERSION does not exist"
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.version_changed == 'true' && needs.check-version.outputs.tag_exists == 'false'
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'
          cache: true

      - name: Build release binary
        run: |
          $VERSION = "${{ needs.check-version.outputs.version }}" -replace '^v', ''
          $BUILD_DATE = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          $GIT_COMMIT = git rev-parse --short HEAD
          $GIT_BRANCH = git rev-parse --abbrev-ref HEAD
          
          $LDFLAGS = "-s -w " +
                     "-X 'flutter_takeoff/pkg/version.BuildDate=$BUILD_DATE' " +
                     "-X 'flutter_takeoff/pkg/version.GitCommit=$GIT_COMMIT' " +
                     "-X 'flutter_takeoff/pkg/version.GitBranch=$GIT_BRANCH'"
          
          go build -ldflags $LDFLAGS -o "flutter-installer-$VERSION-windows-amd64.exe" .
          
          # Create checksum
          $hash = Get-FileHash "flutter-installer-$VERSION-windows-amd64.exe" -Algorithm SHA256
          "$($hash.Hash)  flutter-installer-$VERSION-windows-amd64.exe" | Out-File -FilePath "flutter-installer-$VERSION-windows-amd64.exe.sha256" -Encoding ASCII
        shell: powershell

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.check-version.outputs.version }}" -m "Release ${{ needs.check-version.outputs.version }}"
          git push origin "${{ needs.check-version.outputs.version }}"

      - name: Extract changelog
        id: changelog
        run: |
          $VERSION = "${{ needs.check-version.outputs.version }}" -replace '^v', ''
          
          if (Test-Path "CHANGELOG.md") {
            $content = Get-Content "CHANGELOG.md" -Raw
            
            # Extract section for this version
            $pattern = "(?s)## \[$VERSION\].*?(?=## \[|$)"
            if ($content -match $pattern) {
              $changelog = $matches[0]
              $changelog = $changelog -replace "## \[$VERSION\].*?\n", ""
              $changelog = $changelog.Trim()
            } else {
              $changelog = "Release version $VERSION"
            }
          } else {
            $changelog = "Release version $VERSION"
          }
          
          $changelog | Out-File -FilePath changelog.txt -Encoding UTF8
        shell: powershell

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.version }}
          name: Flutter Takeoff ${{ needs.check-version.outputs.version }}
          draft: false
          prerelease: ${{ contains(needs.check-version.outputs.version, 'beta') || contains(needs.check-version.outputs.version, 'rc') || contains(needs.check-version.outputs.version, 'alpha') }}
          body_path: changelog.txt
          files: |
            flutter-installer-*-windows-amd64.exe
            flutter-installer-*-windows-amd64.exe.sha256
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
